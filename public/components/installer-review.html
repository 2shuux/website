<link rel="import" href="/static/polymer/polymer.html">
<link rel="import" href="/static/components/installer-pane.html">
<link rel="import" href="/static/components/installer-list.html">
<link rel="import" href="/static/components/installer-diff.html">
<link rel="import" href="/static/iron-ajax/iron-ajax.html">

<dom-module id="installer-review">
  <template>
    <div class="row">
      <div class="col-sm-12">
        <h1><a href="[[game.slug]]">[[game.name]]</a> installers</h1>
      </div>
      <div class="col-sm-2">
        <button on-tap="onSwitchDiff" class="btn">Diff</button>
      </div>
      <div class="col-sm-5">
        <button on-tap="onDeleteInstaller" class="btn">Delete</button>
      </div>
    </div>
    <div class="row">
      <installer-list class="col-sm-2" id="installer-list" installers="[[game.installers]]"></installer-list>
      <installer-pane
        class="col-sm-5"
        id="pane-1"
        source-visible="[[sourceVisible]]"
        installer="[[activeInstaller1]]">
      </installer-pane>
      <installer-pane
        class="col-sm-5"
        id="pane-2"
        source-visible="[[sourceVisible]]"
        installer="[[activeInstaller2]]">
      </installer-pane>
      <installer-diff
        class="col-sm-10"
        hidden="[[sourceVisible]]"
        name="{{objectName}}"
        installer1="[[activeInstaller1]]"
        installer2="[[activeInstaller2]]">
      </installer-diff>
    </div>

    <iron-ajax
      auto
      url="/api/installers/game/[[slug]]/revisions"
      headers='{"Authorization": "Token [[apiKey]]"}'
      handle-as="json"
      on-response="handleResponse">
    </iron-ajax>
    <iron-ajax
      id="action-request"
      headers='{"Authorization": "Token [[apiKey]]"}'
      handle-as="json"
      on-response="handleAction">
    </iron-ajax>
  </template>
  <script>
    Polymer({
      is: 'installer-review',
      properties: {
        slug: String,
        apiKey: String,
        sourceVisible: Boolean,
        game: {
          type: Object,
          default: {}
        },
        selectedObject: {
          type: Object,
          default: {}
        },
        activeInstaller1: Object,
        activeInstaller2: Object,
        activePane: {
          type: String,
          default: 'pane-1'
        },
        objectName: {
          type: String,
          computed: 'getObjectName(selectedObject)'
        }
      },

      listeners: {
        'load-installer': 'onLoadInstaller',
        'load-revision': 'onLoadRevision'
      },

      ready: function() {
        this.sourceVisible = false;
      },

      getObjectName: function(selectedObject) {
        console.log("!!")
        if (!selectedObject) {
          return;
        }
        if ('comment' in selectedObject) {
          return selectedObject.comment;
        } else if ('slug' in selectedObject) {
          return selectedObject.slug;
        } else {
          return "???";
        }
      },

      handleResponse: function(response) {
        this.game = response.detail.__data__.response;
      },

      onLoadInstaller: function (event) {
        const installerSlug = event.detail.installerSlug;

        let selectedInstaller = null;
        this.game.installers.forEach(function(installer) {
          if(installer.slug == installerSlug) {
            selectedInstaller = installer;
          }
        });
        if(selectedInstaller) {
          this.selectedObject = selectedInstaller;
          this.activeInstaller1 = this.activeInstaller2;
          this.activeInstaller2 = selectedInstaller;
        }
      },

      onLoadRevision: function (event) {
        const installerSlug = event.detail.installerSlug;
        const revisionId = event.detail.revisionId;
        let selectedRevision = null;
        this.game.installers.forEach(function (installer) {
          if(installer.slug == installerSlug) {
            installer.revisions.forEach(function(revision) {
              if(revision.id == revisionId) {
                selectedRevision = revision;
              }
            });
          }
        });
        if(selectedRevision) {
          this.selectedObject = selectedRevision;
          this.activeInstaller1 = this.activeInstaller2;
          this.activeInstaller2 = selectedRevision.data;
        }
      },

      onSwitchDiff: function (event) {
        this.sourceVisible = !this.sourceVisible;
      },

      onDeleteInstaller: function (event) {
        const name = this.getObjectName();
        if (name) {
          // confirm(`Are you sure you want to delete ${name}?`)
          const actionRequest = this.$['action-request'];
          if ('comment' in this.selectedObject) {
            action_url = `/api/installers/revisions/${this.selectedObject.id}`;
          } else {
            action_url = `/api/installers/${this.selectedObject.slug}`;
          }
          console.log(action_url);

        }
      }
    })
  </script>
</dom-module>
